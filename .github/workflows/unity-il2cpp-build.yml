name: Unity IL2CPP Build Verification

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - '.github/workflows/unity-il2cpp-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - '.github/workflows/unity-il2cpp-build.yml'
  workflow_dispatch:
    inputs:
      testWindows:
        description: 'Test Windows IL2CPP build'
        required: false
        default: 'true'
        type: boolean
      testMacOS:
        description: 'Test macOS IL2CPP build'
        required: false
        default: 'true'
        type: boolean
      testLinux:
        description: 'Test Linux IL2CPP build'
        required: false
        default: 'true'
        type: boolean
      testAndroid:
        description: 'Test Android IL2CPP build'
        required: false
        default: 'true'
        type: boolean
      testWebGL:
        description: 'Test WebGL IL2CPP build'
        required: false
        default: 'true'
        type: boolean

jobs:
  il2cpp-compatibility-check:
    name: IL2CPP Compatibility Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
        
    - name: Verify IL2CPP configuration files
      run: |
        echo "Checking IL2CPP configuration files..."
        
        # Check link.xml exists
        if [ ! -f "Assets/uPiper/link.xml" ]; then
          echo "❌ link.xml not found!"
          exit 1
        else
          echo "✅ link.xml found"
        fi
        
        # Check for Preserve attributes in critical files
        echo "Checking for [Preserve] attributes..."
        grep -r "\[Preserve\]" Assets/uPiper/Runtime/Core/ || true
        
        # List IL2CPP specific files
        echo "IL2CPP specific files:"
        find Assets/uPiper -name "*IL2CPP*" -type f | head -20

  build-il2cpp:
    name: Build IL2CPP - ${{ matrix.targetPlatform }}
    runs-on: ${{ matrix.os }}
    needs: il2cpp-compatibility-check
    strategy:
      fail-fast: false
      matrix:
        include:
          - targetPlatform: StandaloneWindows64
            os: ubuntu-latest
            scriptingBackend: IL2CPP
          - targetPlatform: StandaloneOSX
            os: ubuntu-latest
            scriptingBackend: IL2CPP
          - targetPlatform: StandaloneLinux64
            os: ubuntu-latest
            scriptingBackend: IL2CPP
          - targetPlatform: Android
            os: ubuntu-latest
            scriptingBackend: IL2CPP
          - targetPlatform: WebGL
            os: ubuntu-latest
            scriptingBackend: IL2CPP
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
        
    - name: Cache Library
      uses: actions/cache@v4
      with:
        path: Library
        key: Library-IL2CPP-${{ matrix.targetPlatform }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
        restore-keys: |
          Library-IL2CPP-${{ matrix.targetPlatform }}-
          Library-${{ matrix.targetPlatform }}-
          
    # Free up disk space for IL2CPP builds (they need more space)
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      if: matrix.os == 'ubuntu-latest'
      with:
        tool-cache: false
        android: ${{ matrix.targetPlatform != 'Android' }}
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
        
    # Setup IL2CPP support for Linux
    - name: Setup IL2CPP Linux
      if: matrix.targetPlatform == 'StandaloneLinux64'
      run: |
        sudo apt-get update
        sudo apt-get install -y clang gcc-multilib g++-multilib
        
    # Build with IL2CPP
    - name: Build Unity project with IL2CPP
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        unityVersion: 6000.0.35f1
        targetPlatform: ${{ matrix.targetPlatform }}
        buildName: uPiper-IL2CPP
        buildsPath: build
        buildMethod: UnityBuilderAction.BuildScript.Build
        customParameters: -scriptingBackend ${{ matrix.scriptingBackend }}
        
    # Verify IL2CPP build output
    - name: Verify IL2CPP build
      run: |
        echo "Checking IL2CPP build output for ${{ matrix.targetPlatform }}..."
        
        # Platform specific checks
        case "${{ matrix.targetPlatform }}" in
          StandaloneWindows64)
            if [ -f "build/${{ matrix.targetPlatform }}/uPiper-IL2CPP.exe" ]; then
              echo "✅ Windows IL2CPP executable found"
              ls -la "build/${{ matrix.targetPlatform }}/"
            else
              echo "❌ Windows IL2CPP executable not found!"
              exit 1
            fi
            ;;
          StandaloneLinux64)
            if [ -f "build/${{ matrix.targetPlatform }}/uPiper-IL2CPP" ]; then
              echo "✅ Linux IL2CPP executable found"
              ls -la "build/${{ matrix.targetPlatform }}/"
            else
              echo "❌ Linux IL2CPP executable not found!"
              exit 1
            fi
            ;;
          StandaloneOSX)
            if [ -d "build/${{ matrix.targetPlatform }}/uPiper-IL2CPP.app" ]; then
              echo "✅ macOS IL2CPP app bundle found"
              ls -la "build/${{ matrix.targetPlatform }}/"
            else
              echo "❌ macOS IL2CPP app bundle not found!"
              exit 1
            fi
            ;;
          Android)
            if [ -f "build/${{ matrix.targetPlatform }}/uPiper-IL2CPP.apk" ]; then
              echo "✅ Android IL2CPP APK found"
              ls -la "build/${{ matrix.targetPlatform }}/"
            else
              echo "❌ Android IL2CPP APK not found!"
              exit 1
            fi
            ;;
          WebGL)
            if [ -d "build/${{ matrix.targetPlatform }}/uPiper-IL2CPP" ]; then
              echo "✅ WebGL IL2CPP build found"
              ls -la "build/${{ matrix.targetPlatform }}/uPiper-IL2CPP/"
            else
              echo "❌ WebGL IL2CPP build not found!"
              exit 1
            fi
            ;;
        esac
        
    # Upload IL2CPP build artifacts
    - name: Upload IL2CPP build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: IL2CPP-Build-${{ matrix.targetPlatform }}
        path: build/${{ matrix.targetPlatform }}
        retention-days: 7
        
  performance-comparison:
    name: Performance Report
    needs: build-il2cpp
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate IL2CPP Performance Summary
      run: |
        echo "# IL2CPP Build Verification Summary" > il2cpp-summary.md
        echo "" >> il2cpp-summary.md
        echo "## Build Status" >> il2cpp-summary.md
        echo "" >> il2cpp-summary.md
        echo "| Platform | IL2CPP Build | Status |" >> il2cpp-summary.md
        echo "|----------|--------------|--------|" >> il2cpp-summary.md
        echo "| Windows  | ✅ | Passed |" >> il2cpp-summary.md
        echo "| macOS    | ✅ | Passed |" >> il2cpp-summary.md
        echo "| Linux    | ✅ | Passed |" >> il2cpp-summary.md
        echo "| Android  | ✅ | Passed |" >> il2cpp-summary.md
        echo "| WebGL    | ✅ | Passed |" >> il2cpp-summary.md
        echo "" >> il2cpp-summary.md
        echo "## Configuration" >> il2cpp-summary.md
        echo "" >> il2cpp-summary.md
        echo "- Unity Version: 6000.0.35f1" >> il2cpp-summary.md
        echo "- Scripting Backend: IL2CPP" >> il2cpp-summary.md
        echo "- link.xml: Present" >> il2cpp-summary.md
        echo "- Stripping Level: Low (configurable)" >> il2cpp-summary.md
        echo "" >> il2cpp-summary.md
        echo "## Optimizations Applied" >> il2cpp-summary.md
        echo "" >> il2cpp-summary.md
        echo "- Type preservation via link.xml" >> il2cpp-summary.md
        echo "- [Preserve] attributes on P/Invoke types" >> il2cpp-summary.md
        echo "- Generic type pre-instantiation" >> il2cpp-summary.md
        echo "- Platform-specific worker thread configuration" >> il2cpp-summary.md
        
    - name: Upload performance summary
      uses: actions/upload-artifact@v4
      with:
        name: IL2CPP-Performance-Summary
        path: il2cpp-summary.md
        retention-days: 7
        
    # Post summary as PR comment if this is a PR
    - name: Post IL2CPP summary to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('il2cpp-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });