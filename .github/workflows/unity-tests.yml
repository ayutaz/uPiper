name: Unity Tests

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Unity Test Runner
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
        
    - name: Cache Library
      uses: actions/cache@v4
      with:
        path: Library
        key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
        restore-keys: |
          Library-
          
    # Unity 6対応 - game-ci/unity-test-runnerを使用
    - name: Run Unity Tests
      uses: game-ci/unity-test-runner@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        unityVersion: 6000.0.35f1
        testMode: all
        artifactsPath: test-results
        coverageOptions: 'generateAdditionalMetrics;generateHtmlReport;generateBadgeReport;assemblyFilters:+uPiper.Runtime,+uPiper.Scripts.Runtime,-uPiper.Tests*'
        customParameters: '-enableCodeCoverage'
        
    # テスト結果をJUnit形式で保存
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Test Results - Unity
        path: |
          test-results/**/*.xml
          test-results/**/*.html
          test-results/**/*.json
        retention-days: 7
        
    # GitHub Actions UI でテスト結果を表示
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          test-results/editmode-results.xml
          test-results/playmode-results.xml
        check_name: Unity Test Results
        comment_mode: off
        report_individual_runs: true
        
    # テスト結果のデバッグ情報
    - name: Debug Test Results
      if: always()
      run: |
        echo "=== Test Results Directory Contents ==="
        find test-results -type f -name "*.xml" | head -20
        
        echo ""
        echo "=== XML File Contents Sample ==="
        for file in test-results/*.xml test-results/**/*.xml; do
          if [ -f "$file" ]; then
            echo "File: $file"
            head -50 "$file" | grep -E "(test-suite|test-case|TestCase|TestSuite)" || echo "No test elements found"
            echo "---"
          fi
        done
    
    # テスト結果のサマリーを作成
    - name: Create Test Summary
      if: always()
      run: |
        echo "## Unity Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # テスト結果ファイルを検索
        echo "### Test Result Files" >> $GITHUB_STEP_SUMMARY
        find test-results -type f -name "*.xml" | while read file; do
          echo "- $file" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # XMLファイルから結果を抽出
        for file in test-results/*.xml test-results/**/*.xml; do
          if [ -f "$file" ]; then
            echo "### $(basename $file .xml)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # 簡易的な結果表示（XMLパース）
            if command -v xmllint &> /dev/null; then
              total=$(xmllint --xpath "count(//test-case)" "$file" 2>/dev/null || echo "0")
              passed=$(xmllint --xpath "count(//test-case[@result='Passed'])" "$file" 2>/dev/null || echo "0")
              failed=$(xmllint --xpath "count(//test-case[@result='Failed'])" "$file" 2>/dev/null || echo "0")
              
              # test-caseが見つからない場合、TestCaseも試す
              if [ "$total" = "0" ]; then
                total=$(xmllint --xpath "count(//TestCase)" "$file" 2>/dev/null || echo "0")
                passed=$(xmllint --xpath "count(//TestCase[@result='Passed'])" "$file" 2>/dev/null || echo "0")
                failed=$(xmllint --xpath "count(//TestCase[@result='Failed'])" "$file" 2>/dev/null || echo "0")
              fi
              
              echo "- Total Tests: $total" >> $GITHUB_STEP_SUMMARY
              echo "- Passed: $passed ✅" >> $GITHUB_STEP_SUMMARY
              echo "- Failed: $failed ❌" >> $GITHUB_STEP_SUMMARY
              
              # test-suiteの総数も表示
              suite_total=$(xmllint --xpath "//test-suite[@type='TestFixture']/@testcasecount" "$file" 2>/dev/null | sed 's/testcasecount="//g' | sed 's/"//g' | paste -sd+ | bc 2>/dev/null || echo "0")
              if [ "$suite_total" != "0" ]; then
                echo "- Test Suite Total: $suite_total" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Test results found in: $file" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
    # カバレッジレポートをアップロード
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Coverage Report
        path: |
          CodeCoverage/**
        retention-days: 7
    
    # コードカバレッジチェック
    - name: Check Code Coverage
      if: always()
      run: |
        # カバレッジサマリーファイルを探す
        echo "=== Looking for coverage files ==="
        find . -name "*.xml" -type f | grep -i coverage || echo "No coverage files found"
        echo "=== Coverage directory structure ==="
        ls -la CodeCoverage/ 2>/dev/null || echo "CodeCoverage directory not found"
        
        coverage_file="CodeCoverage/Report/Summary.xml"
        # 他の可能なパスも試す
        if [ ! -f "$coverage_file" ]; then
          coverage_file=$(find CodeCoverage -name "Summary.xml" -type f | head -1)
        fi
        if [ ! -f "$coverage_file" ]; then
          coverage_file=$(find . -name "*TestCoverageResults*.xml" -type f | head -1)
        fi
        
        if [ -f "$coverage_file" ]; then
          echo "### Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # XMLからカバレッジ情報を抽出
          if command -v xmllint &> /dev/null; then
            line_coverage=$(xmllint --xpath "string(//CoverageSession/Summary/@sequenceCoverage)" "$coverage_file" 2>/dev/null || echo "0")
            branch_coverage=$(xmllint --xpath "string(//CoverageSession/Summary/@branchCoverage)" "$coverage_file" 2>/dev/null || echo "0")
            
            # パーセンテージに変換（0-1の値を0-100に）
            line_percent=$(echo "scale=1; $line_coverage * 100" | bc 2>/dev/null || echo "0")
            branch_percent=$(echo "scale=1; $branch_coverage * 100" | bc 2>/dev/null || echo "0")
            
            echo "- Line Coverage: $line_percent%" >> $GITHUB_STEP_SUMMARY
            echo "- Branch Coverage: $branch_percent%" >> $GITHUB_STEP_SUMMARY
            
            # カバレッジバッジデータを環境変数に保存
            echo "LINE_COVERAGE=$line_percent" >> $GITHUB_ENV
            echo "BRANCH_COVERAGE=$branch_percent" >> $GITHUB_ENV
          else
            echo "xmllint not available, skipping coverage parsing" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "Coverage report not found at: $coverage_file" >> $GITHUB_STEP_SUMMARY
        fi
        
    # Codecovにカバレッジをアップロード
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./
        files: 'CodeCoverage/**/*.xml'
        flags: unittests
        name: uPiper
        fail_ci_if_error: false